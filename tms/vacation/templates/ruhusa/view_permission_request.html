{% extends 'base/base.html' %}

{% block content %}
<style>
    /* General Styles */
    body {
        font-family: Arial, sans-serif;
    }

    /* Tables */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }

    table, th, td {
        border: 1px solid #ddd;
    }

    th, td {
        padding: 8px;
        text-align: left;
    }

    th {
        background-color: #f4f4f4;
    }

    tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    button {
        padding: 6px 12px;
        font-size: 14px;
        cursor: pointer;
        border: none;
        border-radius: 4px;
        color: #fff;
        background-color: #007bff;
    }

    button:hover {
        background-color: #0056b3;
    }

    .close-btn {
        background-color: #dc3545;
    }

    .close-btn:hover {
        background-color: #c82333;
    }

    .approve-btn {
        background-color: #28a745;
    }

    .approve-btn:hover {
        background-color: #218838;
    }

    .reject-btn {
        background-color: #dc3545;
    }

    .reject-btn:hover {
        background-color: #c82333;
    }

    .edit-btn {
        background-color: #ffc107;
    }

    .edit-btn:hover {
        background-color: #e0a800;
    }

    /* Overlays */
    .overlay {
        display: none; /* Hidden by default */
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .overlay-content {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        max-width: 600px;
        margin: 0 auto;
        position: relative;
    }

    .overlay-content h2 {
        margin-top: 0;
    }

    .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        border: none;
        background-color: transparent;
        font-size: 16px;
        cursor: pointer;
    }

    /* Action Buttons */
    .action-buttons {
        margin-top: 20px;
    }

    .action-buttons form {
        display: inline-block;
        margin-right: 10px;
    }

    .action-buttons button {
        padding: 8px 16px;
        font-size: 16px;
        cursor: pointer;
        border-radius: 4px;
    }

    /* Edit Form */
    .edit-form {
        display: none;
    }

    /* Delete Confirmation Modal */
    .modal {
        display: none; /* Hidden by default */
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        max-width: 400px;
        margin: 0 auto;
        position: relative;
    }

    .modal-header {
        font-size: 18px;
        margin-bottom: 20px;
    }

    .modal-buttons {
        display: flex;
        justify-content: flex-end;
    }

    .modal-buttons button {
        margin-left: 10px;
        padding: 8px 16px;
        font-size: 16px;
        cursor: pointer;
        border-radius: 4px;
    }

    .modal-cancel-btn {
        background-color: #6c757d;
    }

    .modal-cancel-btn:hover {
        background-color: #5a6268;
    }

    .modal-confirm-btn {
        background-color: #dc3545;
    }

    .modal-confirm-btn:hover {
        background-color: #c82333;
    }
</style>

<h1>Permission Requests</h1>

<!-- User's Own Requests -->
<h2>Your Requests</h2>
<table>
    <thead>
        <tr>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Delegatee</th>
            <th>Status</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% if own_requests %}
            {% for request in own_requests %}
                <tr>
                    <td>{{ request.start_date }}</td>
                    <td>{{ request.end_date }}</td>
                    <td>{{ request.delegatee_name }}</td>
                    <td>{{ request.status }}</td>
                    <td><button onclick="showOverlay('overlay-{{ request.id }}')">View</button></td>
                </tr>
            {% endfor %}
        {% else %}
            <tr><td colspan="5">You have no requests.</td></tr>
        {% endif %}
    </tbody>
</table>

<!-- Delegatee Requests -->
<h2>Requests Assigned to You</h2>
<table>
    <thead>
        <tr>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Requester</th>
            <th>Status</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% if delegated_requests %}
            {% for request in delegated_requests %}
                <tr>
                    <td>{{ request.start_date }}</td>
                    <td>{{ request.end_date }}</td>
                    <td>{{ request.requester_name }}</td>
                    <td>{{ request.status }}</td>
                    <td><button onclick="showOverlay('overlay-delegated-{{ request.id }}')">More</button></td>
                </tr>
            {% endfor %}
        {% else %}
            <tr><td colspan="5">No requests assigned to you.</td></tr>
        {% endif %}
    </tbody>
</table>
<!-- Role-Based Requests -->
{% if is_production or is_technical_manager or is_treasurer or is_director %}
    <h2>Role-Based Requests</h2>
    <table>
        <thead>
            <tr>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Requester</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
         <!-- Role-Based Requests -->
{% if role_based_requests %}
{% for request in role_based_requests %}
    {% if is_production %}
        {% if request.status == 'Under Review' and request.approved_by_delegatee and not request.approved_by_production %}
            <tr>
                <td>{{ request.start_date }}</td>
                <td>{{ request.end_date }}</td>
                <td>{{ request.requester_name }}</td>
                <td>{{ request.status }}</td>
                <td><button onclick="showOverlay('overlay-role-{{ request.id }}')">More</button></td>
            </tr>
        {% endif %}
    {% elif is_technical_manager %}
        {% if request.status == 'Under Review' and request.approved_by_delegatee and not request.approved_by_technical_manager %}
            <tr>
                <td>{{ request.start_date }}</td>
                <td>{{ request.end_date }}</td>
                <td>{{ request.requester_name }}</td>
                <td>{{ request.status }}</td>
                <td><button onclick="showOverlay('overlay-role-{{ request.id }}')">More</button></td>
            </tr>
        {% endif %}
    {% elif is_treasurer %}
        {% if request.status == 'Under Review' and request.approved_by_delegatee and not request.approved_by_treasurer %}
            <tr>
                <td>{{ request.start_date }}</td>
                <td>{{ request.end_date }}</td>
                <td>{{ request.requester_name }}</td>
                <td>{{ request.status }}</td>
                <td><button onclick="showOverlay('overlay-role-{{ request.id }}')">More</button></td>
            </tr>
        {% endif %}
    {% elif is_director %}
        {% if request.status == 'Under Review' and request.approved_by_production or request.approved_by_technical_manager or request.approved_by_treasurer %}
            <tr>
                <td>{{ request.start_date }}</td>
                <td>{{ request.end_date }}</td>
                <td>{{ request.requester_name }}</td>
                <td>{{ request.status }}</td>
                <td><button onclick="showOverlay('overlay-role-{{ request.id }}')">More</button></td>
            </tr>
        {% endif %}
    {% endif %}
{% endfor %}
{% else %}
<tr><td colspan="5">No role-based requests available.</td></tr>
{% endif %}

        </tbody>
    </table>

    </tbody>
    </table>
{% endif %}

<!-- Overlays -->
{% for request in own_requests %}
<div id="overlay-{{ request.id }}" class="overlay">
    <div class="overlay-content">
        <button class="close-btn" onclick="closeOverlay('overlay-{{ request.id }}')">Close</button>
        <h2>Request Details</h2>
        <div id="view-details-{{ request.id }}">
            <p><strong>Request Description:</strong> {{ request.description }}</p>
            
            <p><strong>Request Date:</strong> {{ request.request_date }}</p>

            <p><strong>Start Date:</strong> {{ request.start_date }}</p>
            

            <p><strong>End Date:</strong> {{ request.end_date }}</p><p>
                <strong>Place:</strong> {{ request.place }}</p>
            <p><strong>Delegatee:</strong> {{ request.delegatee_name }}</p>
            
            <p><strong>Reporting:</strong> {{ request.reporting_date }}</p>
            
            <p><strong>Status:</strong> {{ request.status }}</p>
        </div>
        
        <!-- Edit Form (Initially Hidden) -->
        <form method="post" action="{% url 'vacation:edit_request' request.id %}" id="edit-form-{{ request.id }}" class="edit-form">
            {% csrf_token %}
            <label for="description">Description:</label>
            <input type="text" name="description" value="{{ request.description }}">
            
            <label for="start_date">Start Date:</label>
            <input type="date" name="start_date" value="{{ request.start_date }}">
            
            <label for="end_date">End Date:</label>
            <input type="date" name="end_date" value="{{ request.end_date }}">

            
            <button type="submit" class="edit-btn">Save Changes</button>
        </form>
        
        {% if request.status == 'pending' %}
        <div class="action-buttons">
            <button class="edit-btn" onclick="toggleEditForm({{ request.id }})">Edit</button>
            <button class="reject-btn" onclick="openDeleteModal({{ request.id }})">Delete</button>
        </div>
        {% endif %}
    </div>
</div>
{% endfor %}

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <p class="modal-header">Are you sure you want to delete this request?</p>
        <div class="modal-buttons">
            <button class="modal-cancel-btn" onclick="closeDeleteModal()">Cancel</button>
            <form method="post" action="" id="deleteForm">
                {% csrf_token %}
                <button type="submit" class="modal-confirm-btn">Delete</button>
            </form>
        </div>
    </div>
</div>

{% for request in delegated_requests %}
<div id="overlay-delegated-{{ request.id }}" class="overlay">
    <div class="overlay-content">
        <button class="close-btn" onclick="closeOverlay('overlay-delegated-{{ request.id }}')">Close</button>
        <h2>Request Details</h2>
        <p><strong>Description:</strong> {{ request.description }}</p>
        <p><strong>Start Date:</strong> {{ request.start_date }}</p>
        <p><strong>End Date:</strong> {{ request.end_date }}</p>
        <p><strong>Requester:</strong> {{ request.requester_name }}</p>
        <p><strong>Status:</strong> {{ request.status }}</p>
        
        {% if request.status == 'pending' %}
            
       
            
        <div class="action-buttons">
            <form method="post" id="approveForm" action="{% url 'vacation:approve_request' request.id %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="approve-btn">Approve</button>
            </form>
            <form method="post" id="rejectForm" action="{% url 'vacation:reject_request' request.id %}" style="display: inline;">
                {% csrf_token %}
                  <button class="reject-btn" onclick="openRejectModal('{{ request.id }}')">Reject</button>
            </form>
        </div>
         {% endif %}
    </div>
</div>
{% endfor %}

{% for request in role_based_requests %}
<div id="overlay-role-{{ request.id }}" class="overlay">
    <div class="overlay-content">
        <button class="close-btn" onclick="closeOverlay('overlay-role-{{ request.id }}')">Close</button>
        <h2>Request Details</h2>
        <p><strong>Description:</strong> {{ request.description }}</p>
        <p><strong>Start Date:</strong> {{ request.start_date }}</p>
        <p><strong>End Date:</strong> {{ request.end_date }}</p>
        <p><strong>Requester:</strong> {{ request.user.get_full_name }}</p>

        <p><strong>Status:</strong> {{ request.status }}</p>
        
        <div class="action-buttons">
            <form method="post" id="approveForm" action="{% url 'vacation:approve_request' request.id %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="approve-btn">Approve</button>
            </form>
            <form method="post" id="rejectForm" action="{% url 'vacation:reject_request' request.id %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="reject-btn">Reject</button>
            </form>
        </div>
    </div>
</div>
{% endfor %}


<script>
    function showOverlay(overlayId) {
        document.getElementById(overlayId).style.display = 'flex';
    }

    function closeOverlay(overlayId) {
        document.getElementById(overlayId).style.display = 'none';
    }

    function toggleEditForm(requestId) {
        var viewDetails = document.getElementById('view-details-' + requestId);
        var editForm = document.getElementById('edit-form-' + requestId);
        if (editForm.style.display === 'none') {
            viewDetails.style.display = 'none';
            editForm.style.display = 'block';
        } else {
            viewDetails.style.display = 'block';
            editForm.style.display = 'none';
        }
    }

    function openDeleteModal(requestId) {
        var deleteModal = document.getElementById('deleteModal');
        deleteModal.style.display = 'flex';

        var deleteForm = document.getElementById('deleteForm');
        deleteForm.action = "{% url 'vacation:delete_request' 0 %}".replace(0, requestId);
    }

    function closeDeleteModal() {
        var deleteModal = document.getElementById('deleteModal');
        deleteModal.style.display = 'none';
    }
</script>

<script>
    // Function to show the overlay for any request
    function showOverlay(overlayId) {
        document.getElementById(overlayId).style.display = 'flex';
    }

    // Function to close the overlay
    function closeOverlay(overlayId) {
        document.getElementById(overlayId).style.display = 'none';
    }

    // Function to open the approve modal
    function openApproveModal(requestId, type) {
        var approveModal = document.getElementById('approveModal');
        approveModal.style.display = 'flex';

        // Set the correct action for the approve form
        var approveForm = document.getElementById('approveForm');
        approveForm.action = "{% url 'vacation:approve_request' 0 %}".replace(0, requestId);
    }

    // Function to close the approve modal
    function closeApproveModal() {
        var approveModal = document.getElementById('approveModal');
        approveModal.style.display = 'none';
    }

    // Function to open the reject modal
    function openRejectModal(requestId, type) {
        var rejectModal = document.getElementById('rejectModal');
        rejectModal.style.display = 'flex';

        // Set the correct action for the reject form
        var rejectForm = document.getElementById('rejectForm');
        rejectForm.action = "{% url 'vacation:reject_request' 0 %}".replace(0, requestId);
    }

    // Function to close the reject modal
    function closeRejectModal() {
        var rejectModal = document.getElementById('rejectModal');
        rejectModal.style.display = 'none';
    }
</script>


<script>
    function openRejectModal(requestId) {
        var rejectModal = document.getElementById('rejectModal');
        rejectModal.style.display = 'flex';

        var rejectForm = document.getElementById('rejectFormWithReason');
        rejectForm.action = "{% url 'vacation:reject_request' 0 %}".replace(0, requestId);
    }

    function closeRejectModal() {
        var rejectModal = document.getElementById('rejectModal');
        rejectModal.style.display = 'none';
    }


        // Function to open the approve modal
        function openApproveModal(requestId) {
            var approveModal = document.getElementById('approveModal');
            approveModal.style.display = 'flex';
    
            // Set the correct action for the approve form
            var approveForm = document.getElementById('approveForm');
            approveForm.action = "{% url 'vacation:approve_request' 0 %}".replace(0, requestId);
        }
    
        // Function to close the approve modal
        function closeApproveModal() {
            var approveModal = document.getElementById('approveModal');
            approveModal.style.display = 'none';
        }
    
        // Function to open the reject modal
        function openRejectModal(requestId) {
            var rejectModal = document.getElementById('rejectModal');
            rejectModal.style.display = 'flex';
    
            // Set the correct action for the reject form
            var rejectForm = document.getElementById('rejectForm');
            rejectForm.action = "{% url 'vacation:reject_request' 0 %}".replace(0, requestId);
        }
    
        // Function to close the reject modal
        function closeRejectModal() {
            var rejectModal = document.getElementById('rejectModal');
            rejectModal.style.display = 'none';
        }
    </script>
{% endblock %}
