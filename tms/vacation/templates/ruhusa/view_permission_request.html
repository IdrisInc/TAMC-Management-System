{% extends 'base/base.html' %}


{% block title %}
    <title> TAMC | Permission Request </title>
{% endblock title %}
    
{% block content %}
<style>
    /* General Styles */
    body {
        font-family: Arial, sans-serif;
    }

    /* Tables */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }

    table, th, td {
        border: 1px solid #ddd;
    }

    th, td {
        padding: 8px;
        text-align: left;
    }

    th {
        background-color: #f4f4f4;
    }

    tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    button {
        padding: 6px 12px;
        font-size: 14px;
        cursor: pointer;
        border: none;
        border-radius: 4px;
        color: #fff;
        background-color: #007bff;
    }

    button:hover {
        background-color: #0056b3;
    }

    .close-btn {
        background-color: #dc3545;
    }

    .close-btn:hover {
        background-color: #c82333;
    }

    .approve-btn {
        background-color: #28a745;
    }

    .approve-btn:hover {
        background-color: #218838;
    }

    .reject-btn {
        background-color: #dc3545;
    }

    .reject-btn:hover {
        background-color: #c82333;
    }

    .edit-btn {
        background-color: #ffc107;
    }

    .edit-btn:hover {
        background-color: #e0a800;
    }

    /* Overlays */
    .overlay {
        display: none; /* Hidden by default */
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .overlay-content {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        max-width: 600px;
        margin: 0 auto;
        position: relative;
    }

    .overlay-content h2 {
        margin-top: 0;
    }

    .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        border: none;
        background-color: transparent;
        font-size: 16px;
        cursor: pointer;
    }

    /* Action Buttons */
    .action-buttons {
        margin-top: 20px;
    }

    .action-buttons form {
        display: inline-block;
        margin-right: 10px;
    }

    .action-buttons button {
        padding: 8px 16px;
        font-size: 16px;
        cursor: pointer;
        border-radius: 4px;
    }

    /* Edit Form */
    .edit-form {
        display: none;
    }

    /* Delete Confirmation Modal */
    .modal {
        display: none; /* Hidden by default */
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        max-width: 400px;
        margin: 0 auto;
        position: relative;
    }

    .modal-header {
        font-size: 18px;
        margin-bottom: 20px;
    }

    .modal-buttons {
        display: flex;
        justify-content: flex-end;
    }

    .modal-buttons button {
        margin-left: 10px;
        padding: 8px 16px;
        font-size: 16px;
        cursor: pointer;
        border-radius: 4px;
    }

    .modal-cancel-btn {
        background-color: #6c757d;
    }

    .modal-cancel-btn:hover {
        background-color: #5a6268;
    }

    .modal-confirm-btn {
        background-color: #dc3545;
    }

    .modal-confirm-btn:hover {
        background-color: #c82333;
    }
</style>
<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>Permission Request</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="#">Home</a></li>
                        <li class="breadcrumb-item active">Permission Request</li>
                    </ol>
                </div>
            </div>
        </div>
    </section>


<!-- User's Own Requests -->
<!-- Toggle Buttons -->
<section class="content">
<div class="container-fluid">
    <div class="row mb-5 ">
        {% for message in messages %}
        <div class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
        <!-- If there are only two buttons -->
        {% if not is_production and not is_technical_manager and not is_treasurer and not is_director  and not is_assistant_treasurer %}
            <div class="col-6">
                <button id="your-requests-btn" class="btn btn-primary btn-lg btn-block active">My Request</button>
            </div>
            <div class="col-6">
                <button id="assigned-requests-btn" class="btn btn-warning btn-lg btn-block">Assigned</button>
            </div>
        {% else %}
            <!-- If there are three buttons -->
            <div class="col-5">
                <button id="your-requests-btn" class="btn btn-primary btn-lg btn-block active">My Request</button>
            </div>
            <div class="col-4">
                <button id="assigned-requests-btn" class="btn btn-warning btn-lg btn-block">Assigned </button>
            </div>
            <div class="col-3.4">
                <button id="role-requests-btn" class="btn btn-success btn-lg btn-block">Approve</button>
            </div>
        {% endif %}
    </div>
</div>



<div class="card ">
<div id="your-requests-section"  style="display: block;">
<h2 class="card-title ml-3" >My Requests</h2>

<table id="requests-table" class="table">
    <thead>
        <tr>
            <th> Request For </th>
            <th> Duration </th>
            {% comment %} <th>Start Date</th> {% endcomment %}
            {% comment %} <th>End Date</th> {% endcomment %}
            {% comment %} <th>Delegatee</th> {% endcomment %}
            <th>Status</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody id="requests-tbody">
        {% if own_requests %}
            {% for request in own_requests %}
            <tr  data-start-date="{{ request.start_date }}" data-end-date="{{ request.end_date }}">
                <td> {{request.description}}</td>
                
                <td class="duration-cell">{{ request.start_date }} - {{ request.end_date }}</td>
               
                <td class="{% if request.status == 'pending' %}text-warning{% elif request.status == 'Approved' %}text-success{% elif request.status == 'Rejected' %}text-danger{% else %}text-info{% endif %}">
                    {{ request.status }}
                </td>
                <td><button class="btn btn-primary" data-toggle="modal" data-target="#requestModal-{{ request.id }}">View</button></td>
            </tr>

 <!-- Modal Structure for Viewing Details -->
<div class="modal fade" id="requestModal-{{ request.id }}" tabindex="-1" role="dialog" aria-labelledby="requestModalLabel-{{ request.id }}" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="requestModalLabel-{{ request.id }}">Request Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Request Details -->
                <div id="view-details-{{ request.id }}">
                    <p><strong>Request Description:</strong> {{ request.description }}</p>
                    <p><strong>Request Date:</strong> {{ request.request_date }}</p>
                    <p class="duration" 
   data-start-date="{{ request.start_date }}" 
   data-end-date="{{ request.end_date }}">
   <strong>Duration:</strong>
   {{ request.start_date }} - {{ request.end_date }} 
   <span class="days-text"></span>
</p>

                    <p><strong>Place Where I go:</strong> {{ request.place }}</p>
                    <p><strong>Delegatee:</strong> {{ request.delegatee.get_full_name }}</p>
                    <p><strong>Reporting Date:</strong> {{ request.reporting_date }}</p>
                     <p class="{% if request.status == 'pending' %}text-warning{% elif request.status == 'Approved' %}text-success{% elif request.status == 'Rejected' %}text-danger{% else %}text-info{% endif %}"> 
                        <p><strong>Duties:</strong>
                            <ul>
                                {% for duty in request.get_duties_list %}
                                    <li>{{ duty }}</li>
                                {% empty %}
                                    <li>No duties assigned.</li>
                                {% endfor %}
                            </ul>
                        </p>
                     
                        <strong>Status: </strong>         {{ request.status }}
                                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <!-- Action Buttons: Edit and Delete -->
               <!-- Action Buttons: Edit and Delete -->
{% if request.status == 'pending' %}
<a href="{% url 'vacation:edit_request' request.id %}" class="btn btn-warning">Edit</a>
                    
<button type="button" class="btn btn-danger" data-toggle="modal" data-target="#deleteModal-{{ request.id }}">Delete</button>
{% endif %}

            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function() {
        const rows = document.querySelectorAll("#requests-tbody tr");
        
        rows.forEach(row => {
            const startDate = new Date(row.dataset.startDate);
            const endDate = new Date(row.dataset.endDate);
            const durationCell = row.querySelector(".duration-cell");

            // Check if dates are valid
            if (startDate instanceof Date && !isNaN(startDate) && endDate instanceof Date && !isNaN(endDate)) {
                // Calculate duration in days
                const duration = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1; // Add 1 to include both start and end days

                // Format the dates and display the result
                const startDateString = startDate.toLocaleDateString();
                const endDateString = endDate.toLocaleDateString();
                durationCell.textContent = `${startDateString} - ${endDateString} (${duration} days)`;
            } else {
                durationCell.textContent = "Invalid Dates";
            }
        });
    });
</script>


<!-- Modal Structure for Editing the Request -->
<div class="modal fade" id="editModal-{{ request.id }}" tabindex="-1" role="dialog" aria-labelledby="editModalLabel-{{ request.id }}" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <a href="{% url 'vacation:edit_request' request.id %}" class="btn btn-warning">Edit</a>
                    
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Edit Form -->
                <form method="post" action="{% url 'vacation:edit_request' request.id %}">
                    {% csrf_token %}
                    
                    <!-- Address Field -->
                    <div class="form-group">
                        <label for="address">Your Address:</label>
                        <input type="text" name="address" class="form-control" value="{{ request.address }}" required>
                    </div>
                    
                    <!-- Start Date and End Date -->
                    <div class="form-group">
                        <label for="start_date">Start Date:</label>
                        <input type="date" name="start_date" class="form-control" value="{{ request.start_date }}" required>

                        <label for="end_date">End Date:</label>
                        <input type="date" name="end_date" class="form-control" value="{{ request.end_date }}" required>
                    </div>
                    
                    <!-- Place and Description -->
                    <div class="form-group">
                        <label for="place">Place Where You Are Going:</label>
                        <input type="text" name="place" class="form-control" value="{{ request.place }}" required>

                        <label for="description">Permission Description:</label>
                        <textarea name="description" class="form-control" rows="4" required>{{ request.description }}</textarea>
                    </div>
                    
                   <!-- Delegatee -->
<div class="form-group">
    <label for="delegatee">Select Delegatee:</label>
    <select id="delegatee" name="delegatee" class="form-control" required>
        <option value="">Select...</option>
        {% for user in delegatees %}
            <option value="{{ user.id }}" {% if user.id == selected_delegatee_id %}selected{% endif %}>
                {{ user.get_full_name }}
            </option>
        {% endfor %}
    </select>
</div>

                    
                    
                    <!-- Reporting Date -->
                    <div class="form-group">
                        <label for="reporting_date">Reporting Back On:</label>
                        <input type="date" name="reporting_date" class="form-control" value="{{ request.reporting_date }}" required>
                    </div>

                    <!-- Duties (Editable list of duties) -->
                    <div class="form-group">
                        <label for="duties">Duties:</label>
                        <div id="dutyContainer-{{ request.id }}" class="dynamic-duties">
                            <input type="text" id="dutyInput-{{ request.id }}" class="form-control" placeholder="Enter duty and press Add" />
                            <button type="button" class="btn btn-primary mt-2" id="addDuty-{{ request.id }}">Add Duty</button>
                            <div id="dutyList-{{ request.id }}" class="mt-2">
                                {% for duty in request.duties.all %}
                                    <div class="duty-item">
                                        {{ duty.name }}
                                        <button type="button" class="btn btn-danger btn-sm remove-duty">Remove</button>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-success">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dutyContainer = document.getElementById('dutyContainer-{{ request.id }}');
        const addDutyButton = document.getElementById('addDuty-{{ request.id }}');
        const dutyInput = document.getElementById('dutyInput-{{ request.id }}');
        const dutyList = document.getElementById('dutyList-{{ request.id }}');
    
        addDutyButton.addEventListener('click', function() {
            const dutyText = dutyInput.value.trim();
            if (dutyText) {
                // Create a new duty item
                const dutyItem = document.createElement('div');
                dutyItem.className = 'duty-item';
                dutyItem.innerHTML = `${dutyText} <button type="button" class="btn btn-danger remove-duty">Remove</button>`;
                dutyList.appendChild(dutyItem);
                
                // Clear the input
                dutyInput.value = '';
    
                // Add remove functionality
                dutyItem.querySelector('.remove-duty').addEventListener('click', function() {
                    dutyList.removeChild(dutyItem);
                });
            }
        });
    });
    </script>
    



<!-- Modal for Delete Confirmation -->
<div class="modal fade" id="deleteModal-{{ request.id }}" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel-{{ request.id }}" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel-{{ request.id }}">Confirm Deletion</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this request?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <!-- Delete action -->
                <form method="post" action="{% url 'vacation:delete_request' request.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

            {% endfor %}
        {% else %}
            <tr><td colspan="5">You have no requests.</td></tr>
        {% endif %}
    </tbody>
</table>
<!-- Pagination Controls for 'Your Requests' -->
<div id="pagination-controls-requests" class="pagination ml-2">
    <button id="prevPage">Previous</button>
    <span id="pageNumber">Page 1</span>
    <button id="nextPage">Next</button>
</div>
</div>  

<div id="assigned-requests-section" style="display: none;">
<!-- Delegatee Requests -->
<h2 class="card-title ml-3">Requests Assigned to You</h2>

<table id="delegatee-requests-table" class="table">
    <thead>
        <tr> 
            <th>Request From</th>
            <th>Request For</th>
                    
            <th>Status</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody  id="delegatee-requests-tbody">
        {% if delegated_requests %}
            {% for request in delegated_requests %}
            <tr data-start-date="{{ request.start_date }}" data-end-date="{{ request.end_date }}">
               

                {% comment %} <td class="duration-cell">{{ request.start_date }} - {{ request.end_date }}</td> {% endcomment %}
             
                <td>{{ request.requester_name }}</td>
                 <td> {{request.description}}</td>
                <td class="{% if request.status == 'pending' %}text-warning{% elif request.status == 'Approved' %}text-success{% elif request.status == 'Rejected' %}text-danger{% else %}text-info{% endif %}">
                    {{ request.status }}
                </td>
                    <td><button class="btn btn-primary" data-toggle="modal" data-target="#delegatedRequestModal-{{ request.id }}">More</button></td>
                </tr>

                <!-- Modal Structure -->
                <div class="modal fade" id="delegatedRequestModal-{{ request.id }}" tabindex="-1" role="dialog" aria-labelledby="delegatedRequestModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="delegatedRequestModalLabel">Request Details</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <p><strong>Request From:</strong> {{ request.requester_name }}</p>
                                <p> <strong> Requested At: </strong> {{request.request_date}}</p>
                                <p> <strong> Request For: </strong> {{request.description}}</p>
                                <p class="duration" 
                                data-start-date="{{ request.start_date }}" 
                                data-end-date="{{ request.end_date }}">
                                <strong>Duration:</strong>
                                {{ request.start_date }} - {{ request.end_date }} 
                                <span class="days-text"></span>
                             </p>
                             
                                <p><strong>Place Where I Go:</strong> {{ request.place }}</p> 
                               
                                <p> <strong> Reporting Back at: </strong> {{request.reporting_date}} </p>
                                <p><strong>Requester Duties:</strong>
                                    <ul>
                                        {% for duty in request.get_duties_list %}
                                            <li>{{ duty }}</li>
                                        {% empty %}
                                            <li>No duties assigned.</li>
                                        {% endfor %}
                                    </ul>
                                </p>
                                <p class="{% if request.status == 'pending' %}text-warning{% elif request.status == 'Approved' %}text-success{% elif request.status == 'Rejected' %}text-danger{% else %}text-info{% endif %}">
                                    <strong>Status:</strong>    {{ request.status }}
                                </p>
                                <!-- Add additional request details here -->
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>

                                {% if request.status == 'pending' %}
                                <form method="post" action="{% url 'vacation:approve_request' request.id %}" style="display:inline;">
                                    {% csrf_token %}
                                    <button onclick="approveRequest({{ request.id }})" class="btn btn-success">Approve</button>
                                </form>
                                <form method="post" action="{% url 'vacation:reject_request' request.id %}" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-danger">Reject</button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <tr><td colspan="5">No requests assigned to you.</td></tr>
        {% endif %}
    </tbody>
</table>
<!-- Pagination Controls for 'Requests Assigned to You' -->
<div id="pagination-controls-delegatee" class="pagination ml-2">
    <button id="delegatee-prevPage">Previous</button>
    <span id="delegatee-pageNumber">Page 1</span>
    <button id="delegatee-nextPage">Next</button>
</div>
</div>


<!-- Role-Based Requests -->
{% if is_production or is_technical_manager or is_treasurer or is_assistant_treasurer or is_director %}
<div id="role-requests-section" style="display: none;">

     <h2 class="card-title ml-3"> Requests for Approval</h2>
    <table id="role-based-requests-table" class="table">
        <thead>
            <tr>
                <th>Request From</th>
                <th>Request For</th>

                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="role-based-requests-tbody">
            {% if role_based_requests %}
                {% for request in role_based_requests %}
                <tr data-start-date="{{ request.start_date }}" data-end-date="{{ request.end_date }}">
                    <td>{{ request.requester_name }}</td>
                    <td> {{request.description}}</td>
                    {% comment %} <td class="duration-cell">{{ request.start_date }} - {{ request.end_date }}</td> {% endcomment %}
                    
                    <td class="{% if request.status == 'pending' %}text-warning{% elif request.status == 'Approved' %}text-success{% elif request.status == 'Rejected' %}text-danger{% else %}text-info{% endif %}">
                        {{ request.status }}
                    </td>
                        <td><button class="btn btn-primary" data-toggle="modal" data-target="#roleRequestModal-{{ request.id }}">More</button></td>
                    </tr>

                    <!-- Modal Structure -->
                    <div class="modal fade" id="roleRequestModal-{{ request.id }}" tabindex="-1" role="dialog" aria-labelledby="roleRequestModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="roleRequestModalLabel">Request Details</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body"> 
                                    <p><strong>Request From:</strong> {{ request.requester_name }}</p>
                                    <p> <strong> Requested At: </strong> {{request.request_date}}</p>
                                    <p> <strong> Request For: </strong> {{request.description}}</p>
                                    <p class="duration" 
                                    data-start-date="{{ request.start_date }}" 
                                    data-end-date="{{ request.end_date }}">
                                    <strong>Duration:</strong>
                                    {{ request.start_date }} - {{ request.end_date }} 
                                    <span class="days-text"></span>
                                 </p>
                                 
                                    <p><strong>Place Where I Go:</strong> {{ request.place }}</p> 
                                   
                                    <p> <strong> Reporting Back at: </strong> {{request.reporting_date}} </p>
                                   <p><strong>Requester Duties:</strong>
                                    <ul>
                                        {% for duty in request.get_duties_list %}
                                            <li>{{ duty }}</li>
                                        {% empty %}
                                            <li>No duties assigned.</li>
                                        {% endfor %}
                                    </ul>
                                </p>
                                    <p class="{% if request.status == 'pending' %}text-warning{% elif request.status == 'Approved' %}text-success{% elif request.status == 'Rejected' %}text-danger{% else %}text-info{% endif %}">
                                        <strong>Status:</strong>    {{ request.status }}
                                    </p>                                
                                    <!-- Add additional request details here -->
                                </div>
                                <div class="modal-footer">
                                    {% if request.status == 'Under Review' %}
            
                                    <div class="action-buttons">
                                        <form method="post" id="approveForm-{{ request.id }}" action="{% url 'vacation:approve_request' request.id %}" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="approve-btn">Approve</button>
                                        </form>
                                        <form method="post" id="rejectForm-{{ request.id }}" action="{% url 'vacation:reject_request' request.id %}" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="reject-btn">Reject</button>
                                        </form>
                                    </div>
                                    {% endif %}
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <tr><td colspan="5">No role-based requests available.</td></tr>
            {% endif %}
        </tbody>
    </table>
    <!-- Pagination Controls for 'Role-Based Requests' -->
    <div id="pagination-controls-role" class="pagination ml-2">
        <button id="role-based-prevPage">Previous</button>
        <span id="role-based-pageNumber">Page 1</span>
        <button id="role-based-nextPage">Next</button>
    </div>
{% endif %}
</div>






{% for request in delegated_requests %}
<div id="overlay-delegated-{{ request.id }}" class="overlay">
    <div class="overlay-content">
        <button class="close-btn" onclick="closeOverlay('overlay-delegated-{{ request.id }}')">Close</button>
        <h2>Request Details</h2>
        <p><strong>Description:</strong> {{ request.description }}</p>
        <p>
            <strong>Duration:</strong>
            <p class="duration" 
            data-start-date="{{ request.start_date }}" 
            data-end-date="{{ request.end_date }}">
            <strong>Duration:</strong>
            {{ request.start_date }} - {{ request.end_date }} 
            <span class="days-text"></span>
         </p>
         
        
        <p><strong>Requester:</strong> {{ request.requester_name }}</p>
        <p class="{% if request.status == 'Pending' %}text-warning{% elif request.status == 'Approved' %}text-success{% elif request.status == 'Rejected' %}text-danger{% else %}text-info{% endif %}">
            {{ request.status }}
        </p>
        
        {% if request.status == 'Pending' %}
            
       
            
        <div class="action-buttons">
            <form method="post" id="approveForm" action="{% url 'vacation:approve_request' request.id %}" style="display: inline;">
                {% csrf_token %}
                <button onclick="approveRequest({{ request.id }})" class="btn btn-success">Approve</button>
            </form>
            <form method="post" id="rejectForm" action="{% url 'vacation:reject_request' request.id %}" style="display: inline;">
                {% csrf_token %}
                  <button class="reject-btn" onclick="openRejectModal('{{ request.id }}')">Reject</button>
            </form>
        </div>
         {% endif %}
    </div>
</div>
{% endfor %}


{% for request in role_based_requests %}
<div id="overlay-role-{{ request.id }}" class="overlay" style="display: none;">
    <div class="overlay-content">
        <button class="close-btn" onclick="closeOverlay('overlay-role-{{ request.id }}')">Close</button>
        <h2>Request Details</h2>
        <p><strong>Description:</strong> {{ request.description }}</p>
        <p class="duration" 
           data-start-date="{{ request.start_date }}" 
           data-end-date="{{ request.end_date }}">
           <strong>Duration:</strong>
           {{ request.start_date }} - {{ request.end_date }} 
           <span class="days-text"></span>
        </p>
        <p><strong>Request From:</strong> {{ request.user.get_full_name }}</p>
        <p class="{% if request.status == 'Pending' %}text-warning{% elif request.status == 'Approved' %}text-success{% elif request.status == 'Rejected' %}text-danger{% else %}text-info{% endif %}">
            {{ request.status }}
        </p>
        
        
        {% if status == 'Under Review' %}
            
        
            
        <div class="action-buttons">
            <form method="post" id="approveForm-{{ request.id }}" action="{% url 'vacation:approve_request' request.id %}" style="display: inline;">
                {% csrf_token %}
                <button onclick="approveRequest({{ request.id }})" class="btn btn-success">Approve</button>
            </form>
            <form method="post" id="rejectForm-{{ request.id }}" action="{% url 'vacation:reject_request' request.id %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="reject-btn">Reject</button>
            </form>
        </div>
        {% endif %}
    </div>
</div>
{% endfor %}


    
</div>
</div>
</section>

<script>document.addEventListener("DOMContentLoaded", function() {
    const yourRequestsBtn = document.getElementById("your-requests-btn");
    const assignedRequestsBtn = document.getElementById("assigned-requests-btn");
    const roleRequestsBtn = document.getElementById("role-requests-btn");

    const yourRequestsSection = document.getElementById("your-requests-section");
    const assignedRequestsSection = document.getElementById("assigned-requests-section");
    const roleRequestsSection = document.getElementById("role-requests-section");

    // Show the 'My Requests' section and hide others by default
    yourRequestsSection.style.display = "block";
    assignedRequestsSection.style.display = "none";
    if (roleRequestsSection) {
        roleRequestsSection.style.display = "none";
    }

    // Toggle visibility when buttons are clicked
    yourRequestsBtn.addEventListener("click", function() {
        yourRequestsSection.style.display = "block";
        assignedRequestsSection.style.display = "none";
        if (roleRequestsSection) {
            roleRequestsSection.style.display = "none";
        }

        // Set active button style
        yourRequestsBtn.classList.add("active");
        assignedRequestsBtn.classList.remove("active");
        if (roleRequestsBtn) {
            roleRequestsBtn.classList.remove("active");
        }
    });

    assignedRequestsBtn.addEventListener("click", function() {
        yourRequestsSection.style.display = "none";
        assignedRequestsSection.style.display = "block";
        if (roleRequestsSection) {
            roleRequestsSection.style.display = "none";
        }

        // Set active button style
        yourRequestsBtn.classList.remove("active");
        assignedRequestsBtn.classList.add("active");
        if (roleRequestsBtn) {
            roleRequestsBtn.classList.remove("active");
        }
    });

    if (roleRequestsBtn) {
        roleRequestsBtn.addEventListener("click", function() {
            yourRequestsSection.style.display = "none";
            assignedRequestsSection.style.display = "none";
            roleRequestsSection.style.display = "block";

            // Set active button style
            yourRequestsBtn.classList.remove("active");
            assignedRequestsBtn.classList.remove("active");
            roleRequestsBtn.classList.add("active");
        });
    }
});

document.addEventListener("DOMContentLoaded", function() {
    // Select all elements with the class 'duration'
    const durations = document.querySelectorAll(".duration");

    durations.forEach(function(duration) {
        const startDate = new Date(duration.getAttribute("data-start-date"));
        const endDate = new Date(duration.getAttribute("data-end-date"));

        // Calculate the difference in time (milliseconds)
        const timeDifference = endDate - startDate;

        // Convert time difference to days
        const daysDifference = Math.ceil(timeDifference / (1000 * 3600 * 24));

        // Find the span where the number of days will be shown
        const daysText = duration.querySelector(".days-text");
        daysText.textContent = `(${daysDifference} days)`;
    });
});

document.addEventListener("DOMContentLoaded", function() {
    // Function to calculate duration in days and update cells
    function updateDurationCells(tableBodyId) {
        const rows = document.querySelectorAll(`${tableBodyId} tr`);

        rows.forEach(row => {
            const startDate = new Date(row.dataset.startDate);
            const endDate = new Date(row.dataset.endDate);
            const durationCell = row.querySelector(".duration-cell");

            // Check if dates are valid
            if (startDate instanceof Date && !isNaN(startDate) && endDate instanceof Date && !isNaN(endDate)) {
                // Calculate duration in days
                const duration = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1; // Include both start and end days

                // Format the dates and display the result
                const startDateString = startDate.toLocaleDateString();
                const endDateString = endDate.toLocaleDateString();
                durationCell.textContent = `${startDateString} - ${endDateString} (${duration} days)`;
            } else {
                durationCell.textContent = "Invalid Dates";
            }
        });
    }

    // Update duration cells in both tables
    updateDurationCells("#delegatee-requests-tbody");
    updateDurationCells("#role-based-requests-tbody");
});

// Function to setup pagination for any table
function setupPagination(tableId, tbodyId, prevButtonId, nextButtonId, pageNumberId, rowsPerPage) {
    const table = document.getElementById(tableId);
    const tbody = document.getElementById(tbodyId);
    const rows = tbody.getElementsByTagName("tr");
    let currentPage = 1;

    function displayTable(page) {
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        Array.from(rows).forEach((row, index) => {
            row.style.display = (index >= start && index < end) ? "" : "none";
        });
        document.getElementById(pageNumberId).textContent = `Page ${page}`;
    }

    function updatePagination() {
        document.getElementById(prevButtonId).disabled = currentPage === 1;
        document.getElementById(nextButtonId).disabled = currentPage === Math.ceil(rows.length / rowsPerPage);
    }

    document.getElementById(prevButtonId).addEventListener("click", function () {
        if (currentPage > 1) {
            currentPage--;
            displayTable(currentPage);
            updatePagination();
        }
    });

    document.getElementById(nextButtonId).addEventListener("click", function () {
        if (currentPage < Math.ceil(rows.length / rowsPerPage)) {
            currentPage++;
            displayTable(currentPage);
            updatePagination();
        }
    });

    // Initial setup
    displayTable(currentPage);
    updatePagination();
}

// Initialization
document.addEventListener("DOMContentLoaded", function () {
    // Set up pagination for each table
    setupPagination("requests-table", "requests-tbody", "prevPage", "nextPage", "pageNumber", 5);
    setupPagination("delegatee-requests-table", "delegatee-requests-tbody", "delegatee-prevPage", "delegatee-nextPage", "delegatee-pageNumber", 5);
    setupPagination("role-based-requests-table", "role-based-requests-tbody", "role-based-prevPage", "role-based-nextPage", "role-based-pageNumber", 5);
});

function toggleEditForm(requestId) {
    // Get the elements by ID
    const viewDetails = document.getElementById(`view-details-${requestId}`);
    const editForm = document.getElementById(`edit-form-${requestId}`);
    const editButton = document.getElementById(`edit-button-${requestId}`);
    const saveButton = document.getElementById(`save-button-${requestId}`);

    // Check the current display status of the edit form
    if (editForm.style.display === "none") {
        // Hide the details and show the edit form
        viewDetails.style.display = "none";
        editForm.style.display = "block";

        // Hide the Edit button and show the Save button
        editButton.style.display = "none";
        saveButton.style.display = "inline-block";
    } else {
        // Show the details and hide the edit form
        viewDetails.style.display = "block";
        editForm.style.display = "none";

        // Show the Edit button and hide the Save button
        editButton.style.display = "inline-block";
        saveButton.style.display = "none";
    }
}

// Handle modal opening within another modal
$(document).on('show.bs.modal', '.modal', function (event) {
    var zIndex = 1040 + (10 * $('.modal:visible').length);
    $(this).css('z-index', zIndex);
});

// Ensure to initialize Bootstrap's modal
$(document).ready(function() {
    $('[data-toggle="modal"]').on('click', function() {
        var target = $(this).data('target');
        $(target).modal('show');
    });
});

        


function approveRequest(requestId) {
    fetch(`/vacation:approve_request/${requestId}/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            window.location.href = data.redirect_url; // Redirect on success
        } else {
            alert(data.error); // Show error message
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('There was an error processing your request. Please try again.');
    });
}

function rejectRequest(requestId) {
    const comment = prompt("Please provide a comment for rejection:");
    if (comment) {
        fetch(`/vacation:reject_request/${requestId}/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ comment: comment })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Request rejected successfully.");
                window.location.href = data.redirect_url; // Redirect on success
            } else {
                alert(data.error); // Show error message
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('There was an error processing your request. Please try again.');
        });
    }
}

// Utility function to get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

    </script>
    

   
<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>


{% endblock %}
