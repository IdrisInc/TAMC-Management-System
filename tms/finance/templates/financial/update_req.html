<!-- finance/templates/finance/update_request.html -->
{% extends "base/base.html" %}

{% block title %}
<title>TAMC | Update Financial Request</title>
{% endblock title %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-6">
    <!-- Content Header -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Update Financial Request</h1>
                </div>
                <div class="mt-4 sm:mt-0">
                    <nav class="flex space-x-2 text-sm text-gray-500">
                        <a href="#" class="hover:text-blue-600 transition-colors">Home</a>
                        <span>/</span>
                        <span class="text-gray-700">Financial Form</span>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex justify-center">
            <div class="w-full max-w-4xl">
                <!-- Form Card -->
                <div class="bg-white shadow-lg rounded-lg border border-gray-200">
                    <div class="bg-blue-600 text-white px-6 py-4 rounded-t-lg">
                        <h3 class="text-lg font-medium">Petty/Cheque Request</h3>
                    </div>
                    
                    <form method="post" onsubmit="return validateForm()" class="p-6 space-y-6">
                        {% csrf_token %}
                        
                        <!-- Hidden field -->
                        <input type="hidden" name="request_id" value="{{ request.id }}">
                        
                        <!-- Amount Numeric Field -->
                        <div class="form-group">
                            <label for="amount_numeric" class="block text-sm font-medium text-gray-700 mb-2">
                                Amount in Numeric
                            </label>
                            <input type="number" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                   id="amount_numeric" 
                                   name="amount_numeric" 
                                   value="{{ request.amount_numeric }}" 
                                   readonly required>
                        </div>

                        <!-- Amount in Words Field -->
                        <div class="form-group">
                            <label for="amount_words" class="block text-sm font-medium text-gray-700 mb-2">
                                Amount in Words
                            </label>
                            <input type="text" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                   id="amount_words" 
                                   name="amount_words" 
                                   value="{{ request.amount_words }}" 
                                   readonly required>
                        </div>

                        <!-- Purpose Field -->
                        <div class="form-group">
                            <label for="purpose" class="block text-sm font-medium text-gray-700 mb-2">
                                Purpose
                            </label>
                            <input type="text" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                   id="purpose" 
                                   name="purpose" 
                                   value="{{ request.purpose }}" 
                                   required>
                        </div>

                        <!-- Description of Request Table -->
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-4">
                                Description of Request
                            </label>
                            
                            <div class="overflow-x-auto border border-gray-200 rounded-lg">
                                <table class="min-w-full divide-y divide-gray-200" id="descriptionTable">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Request</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        {% for item in request.items.all %}
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-3">
                                                <input type="text" 
                                                       class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                                                       name="item[]" 
                                                       value="{{ item.item_name }}" 
                                                       required>
                                            </td>
                                            <td class="px-4 py-3">
                                                <input type="number" 
                                                       class="w-full px-2 py-1 border border-gray-300 rounded quantity focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                                                       name="quantity[]" 
                                                       min="0" 
                                                       value="{{ item.quantity }}" 
                                                       required 
                                                       oninput="updateTotal(this)">
                                            </td>
                                            <td class="px-4 py-3">
                                                <input type="number" 
                                                       class="w-full px-2 py-1 border border-gray-300 rounded price focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                                                       name="price[]" 
                                                       min="0" 
                                                       value="{{ item.price }}" 
                                                       required 
                                                       oninput="updateTotal(this)">
                                            </td>
                                            <td class="px-4 py-3">
                                                <input type="text" 
                                                       class="w-full px-2 py-1 border border-gray-300 rounded bg-gray-50 total_request focus:outline-none" 
                                                       name="total_request[]" 
                                                       value="{{ item.total_request }}" 
                                                       readonly required>
                                            </td>
                                            <td class="px-4 py-3">
                                                <button type="button" 
                                                        class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors" 
                                                        onclick="removeRow(this)">
                                                    Remove
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Table Action Buttons -->
                            <div class="mt-4 flex flex-wrap gap-3">
                                <button type="button" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium transition-colors" 
                                        onclick="addRow()">
                                    <i class="fas fa-plus mr-2"></i>Add Item
                                </button>
                                <button type="button" 
                                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-medium transition-colors" 
                                        onclick="calculateTotal()">
                                    <i class="fas fa-calculator mr-2"></i>Calculate Total
                                </button>
                            </div>
                        </div>

                        <!-- Total Request Field -->
                        <div class="form-group">
                            <label for="total_request" class="block text-sm font-medium text-gray-700 mb-2">
                                Total Request
                            </label>
                            <input type="text" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium" 
                                   id="total_request" 
                                   name="total_request" 
                                   value="{{ request.total_request }}" 
                                   readonly>
                        </div>

                        <!-- Submit Button -->
                        <div class="flex justify-end pt-6 border-t border-gray-200">
                            <button type="submit" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-md font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                <i class="fas fa-save mr-2"></i>Update Request
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function addRow() {
        var newRow = '<tr class="hover:bg-gray-50">' +
            '<td class="px-4 py-3"><input type="text" class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" name="item[]" required></td>' +
            '<td class="px-4 py-3"><input type="number" class="w-full px-2 py-1 border border-gray-300 rounded quantity focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" name="quantity[]" min="0" value="0" required oninput="updateTotal(this)"></td>' +
            '<td class="px-4 py-3"><input type="number" class="w-full px-2 py-1 border border-gray-300 rounded price focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" name="price[]" min="0" value="0" required oninput="updateTotal(this)"></td>' +
            '<td class="px-4 py-3"><input type="text" class="w-full px-2 py-1 border border-gray-300 rounded bg-gray-50 total_request focus:outline-none" name="total_request[]" readonly required></td>' +
            '<td class="px-4 py-3"><button type="button" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors" onclick="removeRow(this)">Remove</button></td>' +
            '</tr>';
        $('#descriptionTable tbody').append(newRow);
        calculateTotal();
    }

    function removeRow(button) {
        $(button).closest('tr').remove();
        calculateTotal();
    }

    function updateTotal(element) {
        var row = $(element).closest('tr');
        var quantity = parseFloat(row.find('.quantity').val()) || 0;
        var price = parseFloat(row.find('.price').val()) || 0;
        var total = quantity * price;
        row.find('.total_request').val(total.toFixed(2));
        calculateTotal();
    }

    function calculateTotal() {
        var totalRequest = 0;
        $('#descriptionTable tbody tr').each(function () {
            var total = parseFloat($(this).find('.total_request').val()) || 0;
            totalRequest += total;
        });
        $('#total_request').val(totalRequest.toFixed(2));
        $('#amount_numeric').val(totalRequest.toFixed(2));
        convertAmountToWords();
    }

    function validateForm() {
        var totalRequest = parseFloat(document.getElementById('total_request').value) || 0;
        var amountNumeric = parseFloat(document.getElementById('amount_numeric').value) || 0;

        if (totalRequest > amountNumeric) {
            alert('Total request amount exceeds the specified numeric amount.');
            return false;
        }
        return true;
    }

    $(document).ready(function() {
        $('#descriptionTable').on('input', '.quantity, .price', function() {
            updateTotal(this);
        });
    });

    function convertAmountToWords() {
        var amountNumeric = document.getElementById('amount_numeric').value;
        var amountWords = document.getElementById('amount_words');
        amountWords.value = numberToWords(amountNumeric);
    }

    function numberToWords(number) {
        const units = ['Zero', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
        const teens = ['Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
        const tens = ['Ten', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
        const thousands = ['Thousand', 'Million', 'Billion', 'Trillion'];

        if (number == 0) return 'Zero';

        let word = ' Shilings only';

        function getWords(n, index) {
            if (n == 0) return '';
            let str = '';
            if (n > 99) {
                str += units[Math.floor(n / 100)] + ' Hundred ';
                n %= 100;
            }
            if (n > 10 && n < 20) {
                str += teens[n - 11] + ' ';
            } else {
                if (n > 9) {
                    str += tens[Math.floor(n / 10) - 1] + ' '; 
                    n %= 10;
                }
                if (n > 0) {
                    str += units[n] + ' ';
                }
            }
            return str.trim() + (index > 0 ? ' ' + thousands[index - 1] + ' ' : '');
        }

        let index = 0;
        while (number > 0) {
            const chunk = number % 1000;
            if (chunk) {
                word = getWords(chunk, index) + word;
            }
            number = Math.floor(number / 1000);
            index++;
        }

        return word.trim();
    }
</script>
{% endblock content %}
