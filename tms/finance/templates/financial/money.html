{% extends "base/base.html" %}

{% block title %}
    <title>TAMC | Financial Request Form</title>
{% endblock title %}

{% block content %}
<div class="content-wrapper">
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1>Financial Request</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="#">Home</a></li>
            <li class="breadcrumb-item active">Financial Form</li>
          </ol>
        </div>
      </div>
    </div>
  </section>
  
  <section class="content">
    <div class="container-fluid">
      <div class="row justify-content-center">
        <div class="col-md-9">
          <div class="card card-primary">
            <div class="card-header">
              <h3 class="card-title">Petty/Cheque</h3>
            </div>
            <form method="post" onsubmit="return validateForm()">
              {% csrf_token %}
              <div class="card-body">
                <div class="form-group">
                  <label for="amountNumeric">Numeric Amount</label>
                  <input type="number" class="form-control modern-input" id="amountNumeric" placeholder="eg 2000" name="amount_numeric" readonly>
                </div>
                <div class="form-group">
                  <label for="amountWords">Amount in Words</label>
                  <input type="text" class="form-control modern-input" id="amountWords" placeholder="Two Thousand" name="amount_words" readonly>
                </div>
                <div class="form-group">
                  <label for="purpose">Purpose</label>
                  <input type="text" class="form-control modern-input" id="purpose" placeholder="Transport Fare" name="purpose" required>
                </div>
                <div class="form-group">
                  <label for="description">Description of Request</label>
                  <div class="table-responsive">
                    <table class="table table-bordered modern-table" id="descriptionTable">
                      <thead>
                        <tr>
                          <th>Item</th>
                          <th>Quantity</th>
                          <th>Price</th>
                          <th>Total Request</th>
                          <th>Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td><input type="text" class="form-control modern-input" name="item[]" required placeholder="Transport Fare"></td>
                          <td><input type="number" class="form-control modern-input quantity" name="quantity[]" min="0" value="0" required oninput="updateTotal(this)"></td>
                          <td><input type="number" class="form-control modern-input price" name="price[]" min="0" value="0" required oninput="updateTotal(this)"></td>
                          <td><input type="text" class="form-control modern-input total_request" name="total_request[]" readonly required></td>
                          <td><button type="button" class="btn btn-modern-danger" onclick="removeRow(this)">Remove</button></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <button type="button" class="btn btn-modern-primary" onclick="addRow()">Add Item</button>
                  <button type="button" class="btn btn-modern-success" onclick="calculateTotal()">Calculate Total</button>
                </div>
                <div class="form-group">
                  <label for="totalRequest">Total Request</label>
                  <input type="text" class="form-control modern-input" id="totalRequest" name="total_request" readonly>
                </div>
              </div>
              <div class="card-footer">
                <button type="submit" class="btn btn-modern-primary">Submit</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<style>
  /* Modern styling while maintaining structure */
  .card {
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border: none;
  }
  
  .card-header {
    background-color: #4f46e5;
    color: white;
    border-radius: 10px 10px 0 0 !important;
    padding: 15px 20px;
  }
  
  .card-title {
    font-weight: 600;
    font-size: 1.25rem;
  }
  
  .modern-input {
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    padding: 10px 15px;
    transition: all 0.3s ease;
  }
  
  .modern-input:focus {
    border-color: #4f46e5;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
  }
  
  .modern-table {
    border-radius: 8px;
    overflow: hidden;
  }
  
  .modern-table thead {
    background-color: #f8fafc;
  }
  
  .modern-table th {
    border-bottom: 2px solid #e2e8f0;
    font-weight: 600;
    color: #475569;
  }
  
  .btn-modern-primary {
    background-color: #4f46e5;
    border-color: #4f46e5;
    color: white;
    border-radius: 8px;
    padding: 8px 20px;
    font-weight: 500;
    transition: all 0.3s ease;
  }
  
  .btn-modern-primary:hover {
    background-color: #4338ca;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
  }
  
  .btn-modern-success {
    background-color: #10b981;
    border-color: #10b981;
    color: white;
    border-radius: 8px;
    padding: 8px 20px;
    font-weight: 500;
    transition: all 0.3s ease;
  }
  
  .btn-modern-success:hover {
    background-color: #0d9f6e;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
  }
  
  .btn-modern-danger {
    background-color: #ef4444;
    border-color: #ef4444;
    color: white;
    border-radius: 8px;
    padding: 5px 15px;
    font-weight: 500;
    transition: all 0.3s ease;
  }
  
  .btn-modern-danger:hover {
    background-color: #dc2626;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
  }
  
  .form-group label {
    font-weight: 500;
    color: #475569;
    margin-bottom: 8px;
  }
  
  .content-header h1 {
    color: #1e293b;
    font-weight: 600;
  }
</style>

<script>
  // Your existing JavaScript remains exactly the same
  function addRow() {
    var newRow = '<tr>' +
      '<td><input type="text" class="form-control modern-input" name="item[]" required></td>' +
      '<td><input type="number" class="form-control modern-input quantity" name="quantity[]" min="0" value="0" required oninput="updateTotal(this)"></td>' +
      '<td><input type="number" class="form-control modern-input price" name="price[]" min="0" value="0" required oninput="updateTotal(this)"></td>' +
      '<td><input type="text" class="form-control modern-input total_request" name="total_request[]" readonly required></td>' +
      '<td><button type="button" class="btn btn-modern-danger" onclick="removeRow(this)">Remove</button></td>' +
      '</tr>';
    $('#descriptionTable tbody').append(newRow);
    calculateTotal();
  }

  function removeRow(button) {
    $(button).closest('tr').remove();
    calculateTotal();
  }

  function updateTotal(element) {
    var row = $(element).closest('tr');
    var quantity = parseFloat(row.find('.quantity').val()) || 0;
    var price = parseFloat(row.find('.price').val()) || 0;
    var total = quantity * price;
    row.find('.total_request').val(total.toFixed(2));
    calculateTotal();
  }

  function calculateTotal() {
    var totalRequest = 0;
    $('#descriptionTable tbody tr').each(function () {
      var total = parseFloat($(this).find('.total_request').val()) || 0;
      totalRequest += total;
    });
    $('#totalRequest').val(totalRequest.toFixed(2));

    // Update the amountNumeric field dynamically
    $('#amountNumeric').val(totalRequest.toFixed(2));
    convertAmountToWords();  // Update the amount in words
  }

  function validateForm() {
    var totalRequest = parseFloat(document.getElementById('totalRequest').value) || 0;
    var amountNumeric = parseFloat(document.getElementById('amountNumeric').value) || 0;
    
    if (totalRequest > amountNumeric) {
      alert('Total request amount exceeds the specified numeric amount.');
      return false;
    }
    return true;
  }

  $(document).ready(function() {
    $('#descriptionTable').on('input', '.quantity, .price', function() {
      updateTotal(this);
    });
  });

  function convertAmountToWords() {
    var amountNumeric = document.getElementById('amountNumeric').value;
    var amountWords = document.getElementById('amountWords');
    amountWords.value = numberToWords(amountNumeric);
  }

  function numberToWords(number) {
    const units = ['Zero', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
    const teens = ['Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
    const tens = ['Ten', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
    const thousands = ['Thousand', 'Million', 'Billion', 'Trillion'];

    if (number == 0) return 'Zero';

    let word = ' Shilings only';

    function getWords(n, index) {
      if (n == 0) return '';
      let str = '';
      if (n > 99) {
        str += units[Math.floor(n / 100)] + ' Hundred ';
        n %= 100;
      }
      if (n > 10 && n < 20) {
        str += teens[n - 11] + ' ';
      } else {
        if (n > 9) {
          str += tens[Math.floor(n / 10) - 1] + ' ';
          n %= 10;
        }
        if (n > 0) {
          str += units[n] + ' ';
        }
      }
      return str.trim() + (index > 0 ? ' ' + thousands[index - 1] + ' ' : '');
    }

    let index = 0;
    while (number > 0) {
      const chunk = number % 1000;
      if (chunk) {
        word = getWords(chunk, index) + word;
      }
      number = Math.floor(number / 1000);
      index++;
    }

    return word.trim();
  }
</script>
{% endblock content %}