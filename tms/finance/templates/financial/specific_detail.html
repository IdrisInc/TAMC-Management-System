{% extends 'base/base.html' %}

{% block title %}
    <title>TAMC | Specific Request</title>
{% endblock title %}

{% block content %}
<div class="p-4">
    <!-- Optional Header -->
    <section class="mb-4">
        <!-- Custom content -->
    </section>

    <section>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2">
                {% for message in messages %}
                    <div class="mb-4 px-4 py-2 rounded 
                        {% if message.tags == 'success' %}bg-green-100 text-green-800
                        {% elif message.tags == 'error' %}bg-red-100 text-red-800{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}

                <div class="bg-white shadow rounded-lg p-6">
                    <div class="border-b pb-4 mb-4">
                        <h3 class="text-xl font-semibold flex items-center gap-2 text-gray-800">
                            <i class="fas fa-coins text-blue-600"></i>
                            {% if financial_request.total_request > 50000 %}
                                Cheque Request
                            {% else %}
                                Petty Request
                            {% endif %}
                        </h3>
                    </div>

                    <div id="print-section">
                        <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">
                            <dt class="font-medium text-gray-700">Request From</dt>
                            <dd class="text-gray-900">{{ financial_request.user.get_full_name }}</dd>

                            <dt class="font-medium text-gray-700">Amount Requested</dt>
                            <dd class="text-gray-900">{{ financial_request.amount_numeric }} ({{ financial_request.amount_words }})</dd>

                            <dt class="font-medium text-gray-700">Date Requested</dt>
                            <dd class="text-gray-900">{{ financial_request.created_at }}</dd>

                            <dt class="font-medium text-gray-700">Purpose</dt>
                            <dd class="text-gray-900">{{ financial_request.purpose }}</dd>
                        </dl>

                        <div class="mt-6">
                            <p class="font-semibold text-gray-800">Description of Request</p>
                            <div class="overflow-x-auto">
                                <table class="min-w-full mt-2 text-sm border rounded-lg border-gray-300">
                                    <thead class="bg-gray-100 text-left text-gray-700">
                                        <tr>
                                            <th class="px-4 py-2 border-b">Item</th>
                                            <th class="px-4 py-2 border-b">Quantity</th>
                                            <th class="px-4 py-2 border-b">Price</th>
                                            <th class="px-4 py-2 border-b">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in financial_request.items.all %}
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-4 py-2 border-b">{{ item.item_name }}</td>
                                                <td class="px-4 py-2 border-b">{{ item.quantity }}</td>
                                                <td class="px-4 py-2 border-b">{{ item.price }}</td>
                                                <td class="px-4 py-2 border-b">{{ item.total_request }}</td>
                                            </tr>
                                        {% endfor %}
                                        <tr class="font-bold">
                                            <td colspan="3" class="px-4 py-2 border-t text-right">Total</td>
                                            <td class="px-4 py-2 border-t">{{ financial_request.total_request }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <p class="mt-6 font-medium text-gray-700">Status:
                            <span class="
                                {% if financial_request.status == 'Approved' %}text-green-600
                                {% elif financial_request.status == 'Rejected' %}text-red-600
                                {% elif financial_request.status == 'Pending' %}text-yellow-600
                                {% elif financial_request.status == 'Under Review' %}text-blue-600
                                {% endif %}">
                                {{ financial_request.status }}
                            </span>
                        </p>

                        {% if financial_request.status == 'Rejected' %}
                            <p class="mt-2"><strong>Rejection Comment:</strong> {{ financial_request.rejection_comment }}</p>
                        {% endif %}

                        <div class="mt-4">
                            <p class="font-semibold text-gray-800">Approved By:</p>
                            <ul class="list-disc list-inside text-gray-700 space-y-1 mt-2">
                                {% for role, label in [('approved_by_production', 'Production Manager'),
                                                       ('approved_by_technical_manager', 'Technical Manager'),
                                                       ('approved_by_finance', 'Finance'),
                                                       ('approved_by_treasurer', 'Treasurer'),
                                                       ('approved_by_assistant_treasurer', 'Assistant Treasurer'),
                                                       ('approved_by_cashier', 'Cashier')] %}
                                    {% if financial_request|get_attr:role %}
                                        <li>{{ label }}:
                                            {% for user in financial_request|get_attr:role %}
                                                {{ user.get_full_name }}{% if not forloop.last %}, {% endif %}
                                            {% endfor %}
                                        </li>
                                    {% endif %}
                                {% endfor %}
                            </ul>
                        </div>

                        {% if financial_request.approved_by_finance %}
                            <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 mt-6">
                                <dt class="font-medium text-gray-700">Account to be Charged</dt>
                                <dd class="text-gray-900">{{ financial_request.account_to_charge }}</dd>
                                <dt class="font-medium text-gray-700">Account Code</dt>
                                <dd class="text-gray-900">{{ financial_request.account_code }}</dd>
                            </dl>
                        {% endif %}

                        {% if financial_request.approved_by_cashier.exists %}
                            <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 mt-4">
                                <dt class="font-medium text-gray-700">WEF:</dt>
                                <dd class="text-gray-900">({{ financial_request.wef }})</dd>
                            </dl>
                        {% endif %}
                    </div>

                    <!-- Approval Logic -->
                    {% if financial_request.status != 'Rejected' %}
                        <div class="mt-6">
                            {% include "finance/partials/approval_buttons_tailwind.html" %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock content %}
