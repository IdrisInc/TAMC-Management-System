{% extends "base/base.html" %}
{% load static %}

{% block title  %}
<title> TAMC | Financial Specific Details</title>
{% endblock title  %}


{% block content %}

{% block style %}
    <style>
        @media print {
          .no-print {
            display: none;
          }
        }
      </style><!-- Display messages if any -->
    
{% endblock style %}
    
  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            {% if messages %}
        {% for message in messages %}
            {{ message }}
        {% endfor %}
    {% endif %}
            <h1>Financial Requests</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="#">Home</a></li>
              <li class="breadcrumb-item"><a href="#">Financial Request</a></li>
              <li class="breadcrumb-item active">Specific Requests</li>
            </ol>
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>
    

    {% comment %} <h2 class="mb-4">Specific Detail for {{ user_role|title }} to View Request</h2> {% endcomment %}
    <section class="content">
        <div class="container-fluid">
          <div class="row ">
            <div class="col-md-9">
              <div class="card card-primary">
                <div class="card-header">
                  <h3 class="card-title">
                      <i class="nav-icon fas fa-coins"></i>
                      {% if total > 50000 %}
                          Cheque request
                      {% else %}
                          Petty Request
                      {% endif %}
                  </h3>
              </div>
              
                 <!-- /.card-header -->
              <div class="card-body" id="print-section">
                <dl class="row">
                    <dt class="col-sm-4">Request From </dt>
                        <dd class="col-sm-6">{{ financial_request.user.username }}</dd>
                        <dt class="col-sm-4">Amount Requested
                            <dd class="col-sm-8"> {{ financial_request.amount_numeric }} ({{ financial_request.amount_words }} )</p>
                                <dt class="col-sm-4">Date Requested
                                    <dd class="col-sm-8">{{ financial_request.created_at }}</p>
                                    <dt class="col-sm-4">Purpose
                                        <dd class="col-sm-8"> {{ financial_request.purpose }}</p>

            <!-- Table showing item details -->
            <p><strong>Description of Request</strong></p>
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th scope="col">Item</th>
                        <th scope="col">Quantity</th>
                        <th scope="col">Price</th>
                        <th scope="col">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in financial_request.items.all %}
                        <tr>
                            <td>{{ item.item_name }}</td>
                            <td>{{ item.quantity }}</td>
                            <td>{{ item.price }}</td>
                           
                        </tr>
                    {% endfor %}
                    <tr>
                        <td colspan="3"></td>
                        <td>{{ total }}</td>
                    </tr>
                </tbody>
            </table>

            <p><strong>Status:</strong> 
                <span class="{% if financial_request.status == 'Approved' %}text-success{% elif financial_request.status == 'Rejected' %}text-danger{% elif financial_request.status == 'Pending' %}text-warning{% elif financial_request.status == 'Under Review' %}text-info{% endif %}">
                    {{ financial_request.status }}
                </span>
            </p>
            {% if financial_request.approved_by_cashier %}
              
            <dt class="col-sm-4">Account to be Charged</dt>
              <dd class="col-sm-8"> {{ financial_request.account_to_charge }}</dd>
              <dt class="col-sm-4">Account Code </dt>
              <dd class="col-sm-8">{{ financial_request.account_code }}</dd>
            {% endif %}
          
        </div>

        <div class="col-md-6">
            <!-- Approval Button Logic for Production -->
            {% if user_role == 'Production' %}
            <dd class="col-sm-8">
                <div class="mt-3 no-print">
                {% if financial_request.approved_by_production %}
                    <button disabled class="btn btn-secondary mb-2">Production Approved</button>
                {% else %}
                <dd class="col-sm-8">
                    <div class="mt-3 no-print">
                    <form action="{% url 'finance:approve_request' financial_request.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" name="action" value="approve" class="btn btn-primary mb-2">Approve</button>
                        <button type="submit" name="action" value="reject" class="btn btn-danger mb-2">Reject</button>
                    </form>
                  <div class="mt-3 no-print">
                    </div>
                </dd>
                {% endif %}
            {% endif %}

            
            <!-- Approval Button Logic for Finance -->
            {% if user_role == 'Finance' %}
            <dl>
            <dd class="col-sm-8">
                <div class="mt-3 no-print">
                {% if financial_request.approved_by_finance %}
                    <button disabled class="btn btn-secondary mb-2">Finance Approved</button>
               
                    {% elif financial_request.approved_by_production %}
                <dd class="col-sm-8">
                    <div class="mt-3 no-print">
                <form action="{% url 'finance:approve_request' financial_request.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" name="action" value="approve" class="btn btn-primary mb-2">Approve</button>
                        <button type="submit" name="action" value="reject" class="btn btn-danger mb-2">Reject</button>
                    </form>
                </div>
            </dd>
          </dl>
                {% endif %}
            {% endif %}

            <!-- Approval Button Logic for Treasurer -->
            {% if user_role == 'Treasurer' %}
                {% if financial_request.approved_by_treasurer %}
                    <button disabled class="btn btn-secondary mb-2">Treasurer Approved</button>
                {% elif financial_request.approved_by_finance %}
                <dd class="col-sm-8">
                    <div class="mt-3 no-print">
                <form action="{% url 'finance:approve_request' financial_request.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" name="action" value="approve" class="btn btn-primary mb-2">Approve</button>
                        <button type="submit" name="action" value="reject" class="btn btn-danger mb-2">Reject</button>
                    </form>
                </div>
            </dd>
                {% endif %}
            {% endif %}

            
            {% if user_role == 'Cashier' %}
              <!-- If cashier has approved, display account info -->
              {% if financial_request.approved_by_cashier %}
              
              
            
            {% else %}
              <!-- If cashier hasn't approved, display form to collect account details -->
            
              <form action="{% url 'finance:approve_request' financial_request.id %}" method="post">
                  {% csrf_token %}
                  <div class="mb-3">
                      <label for="account_to_charge" class="form-label">Account to be Charged:</label>
                      <input type="text" name="account_to_charge" id="account_to_charge" class="form-control" required>
                  </div>
                  <div class="mb-3">
                      <label for="account_code" class="form-label">Account Code:</label>
                      <input type="text" name="account_code" id="account_code" class="form-control" required>
                  </div>
                  <button type="submit" name="action" value="approve" class="btn btn-primary mb-2">Approve</button>
                  <button type="submit" name="action" value="reject" class="btn btn-danger mb-2">Reject</button>
              </form>
          {% endif %}
                
            {% endif %}
                
        </div>
    </div>
</div>
<div class="row ml-4">
    <div class="col-12 text-right no-print">
      <button onclick="printContent()" class="btn btn-primary mt-3">Print</button>
    </div>
  </div>

  <!-- /.card -->
</div>
<!-- ./col -->
</div>
<!-- /.row -->
</div>
<!-- /.container-fluid -->
</section>
<script>
    function printContent() {
      window.print();
    }
  </script>
{% endblock %}
